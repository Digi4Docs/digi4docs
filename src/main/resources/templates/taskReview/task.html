<!DOCTYPE html>
<html lang="de"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{./layout}">
<body>
<head>
    <title>Meine Aufgaben</title>
    <script th:src="@{~/js/public.js}" type="text/javascript"></script>
</head>
<body>
<div layout:fragment="title" class="mb-3">Aufgabe: [[${userTask.task.title}]]</div>

<div layout:fragment="content">
    <form th:action="@{'/tasks/task/' + ${userTask.id}}"
          method="post" th:object="${taskReviewForm}" novalidate>
        <div class="alert alert-warning" th:unless="${isOwnTask or userTask.status.toString() == 'DONE'}">
            Diese Aufgabe ist dir nicht zugewiesen. Du schaust sie nur als Administrator an.
            Du kannst deshalb zwar die Informationen in der Aufgabe ändern und bspw. eine
            andere Lehrkraft zuordnen, du kannst die Aufgabe aber nicht erledigen.
        </div>
        <fieldset class="border p-3">
            <div class="d-flex flew-row justify-content-between">
                <div class="flew-grow-1">
                    <legend class="mb-4">Informationen zur Aufgabe</legend>
                    <div class="d-block h5">[[ ${userTask.task.title} ]]</div>
                    <div class="d-block">
                        [(${userTask.task.description})]
                    </div>
                </div>
                <div th:if="${userTask.status.toString() == 'DONE'}">
                    <div class="text-success text-center">
                        <div class="medium-icon">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <div class="d-block h5">erledigt</div>
                        <div class="text-muted small" th:if="${null != userTask.doneAt}">
                            [[ ${#temporals.format(userTask.doneAt, 'dd.MM.yyyy')} ]]<br/>
                            [[ ${#temporals.format(userTask.doneAt, 'HH:mm')} ]] Uhr
                        </div>
                    </div>
                </div>
                <div th:if="${userTask.status.toString() == 'REJECTED'}">
                    <div class="text-danger text-center">
                        <div class="medium-icon">
                            <i class="bi bi-dash-circle-fill"></i>
                        </div>
                        <div class="d-block h5">zurückgegeben</div>
                        <div class="text-muted small" th:if="${null != userTask.rejectedAt}">
                            [[ ${#temporals.format(userTask.rejectedAt, 'dd.MM.yyyy')} ]]<br/>
                            [[ ${#temporals.format(userTask.rejectedAt, 'HH:mm')} ]] Uhr
                        </div>
                    </div>
                </div>
                <div th:if="${userTask.status.toString() == 'TRANSMITTED'}">
                    <div class="text-warning text-center">
                        <div class="medium-icon">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div class="d-block h5">abgeben</div>
                        <div class="text-muted small" th:if="${null != userTask.transmittedAt}">
                            [[ ${#temporals.format(userTask.transmittedAt, 'dd.MM.yyyy')} ]]<br/>
                            [[ ${#temporals.format(userTask.transmittedAt, 'HH:mm')} ]] Uhr
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
        <fieldset class="border p-3 mt-4">
            <legend class="mb-4">Angaben des/der Schüler*in</legend>

            <div class="alert alert-success mb-3" th:if="${success}">Die Aufgabe wurde gespeichert.</div>
            <div class="alert alert-danger mb-3" th:if="${error}">[[${error}]]</div>
            <div class="alert alert-danger mb-3" th:if="${#fields.hasErrors('global')}">
                <span th:each="err : ${#fields.errors('global')}" th:text="${err}"/>
            </div>

            <div class="row">
                <div class="col-12 col-md-4 mb-4 pe-4">
                    <label for="subjectId" class="form-label">Fach</label>
                    <select th:field="*{subjectId}"
                            th:classappend="${#fields.hasErrors('subjectId') ? 'is-invalid' : (#fields.hasAnyErrors() ? 'is-valid' : '')}"
                            class="form-control" name="subjectId" id="subjectId"
                            th:disabled="${userTask.status.toString() != 'TRANSMITTED' || !allowedForAdmins}">
                        <option value="">Bitte wähle ein Fach aus</option>
                        <option th:each="subject: ${subjects}" th:value="${subject.id}">[[ ${subject.name} ]]</option>
                    </select>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('subjectId')}"
                         th:errors="*{subjectId}"></div>
                </div>
                <div class="col-12 col-md-4 mb-4 pe-4">
                    <label for="teacherId" class="form-label">Lehrkraft</label>
                    <select th:field="*{teacherId}"
                            th:classappend="${#fields.hasErrors('teacherId') ? 'is-invalid' : (#fields.hasAnyErrors() ? 'is-valid' : '')}"
                            class="form-control" name="teacherId" id="teacherId"
                            th:disabled="${userTask.status.toString() != 'TRANSMITTED' || !allowedForAdmins}">
                        <option value="">Bitte wähle eine Lehrkraft aus</option>
                        <option th:each="teacher: ${teachers}" th:value="${teacher.id}"
                                th:data-subjects="${teacher.subjects}"
                        >[[ ${teacher.fullname} ]]
                        </option>
                    </select>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('teacherId')}"
                         th:errors="*{teacherId}"></div>
                </div>
                <div class="col-12 col-md-4 mb-4">
                    <label for="date" class="form-label">Datum</label>
                    <input type="date" th:field="*{date}" class="form-control"
                           th:classappend="${#fields.hasErrors('date') ? 'is-invalid' : (#fields.hasAnyErrors() ? 'is-valid' : '')}"
                           id="date" name="date"
                           th:disabled="${userTask.status.toString() != 'TRANSMITTED' || !allowedForAdmins}">
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('date')}" th:errors="*{date}"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <label for="solution" class="form-label">Lernaufgabe / Projekt</label>
                    <textarea th:field="*{solution}" class="form-control" rows="10"
                              th:classappend="${#fields.hasErrors('solution') ? 'is-invalid' : (#fields.hasAnyErrors() ? 'is-valid' : '')}"
                              id="solution" name="solution"
                              th:disabled="${userTask.status.toString() != 'TRANSMITTED' || !allowedForAdmins}">
                    </textarea>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('solution')}"
                         th:errors="*{solution}"></div>
                </div>
            </div>
            <div class="row my-4" th:if="${null != userTask && null != userTask.file}">
                <div class="col-12 mb-2">
                    <label class="form-label">Hochgeladene Datei:</label>
                    <div class="d-block fw-bold">[[${userTask.file.name}]]</div>
                </div>
                <div class="col-12">
                    <a th:href="@{'/public/file/' + ${userTask.file.id}}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-download"></i>
                        Herunterladen
                    </a>
                </div>
            </div>
        </fieldset>
        <div class="row mt-4">
            <div class="col-12">
                <label for="comment" class="form-label">Bemerkung</label>
                <textarea th:field="*{comment}" class="form-control" rows="10"
                          th:classappend="${#fields.hasErrors('comment') ? 'is-invalid' : (#fields.hasAnyErrors() ? 'is-valid' : '')}"
                          id="comment" name="comment"
                          th:disabled="${userTask.status.toString() != 'TRANSMITTED'}"></textarea>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('comment')}"
                     th:errors="*{comment}"></div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <button type="submit" name="done" class="btn btn-success text-white me-1 mb-4 mb-md-0"
                        th:if="${userTask.status.toString() == 'TRANSMITTED' and isOwnTask}">
                    <i class="bi bi-check-circle-fill"></i>
                    Aufgabe als "erledigt" markieren
                </button>
                <button type="submit" name="reject" class="btn btn-danger text-white mb-4 mb-md-0"
                        th:if="${userTask.status.toString() == 'TRANSMITTED' and isOwnTask}">
                    <i class="bi bi-x-circle-fill"></i>
                    Aufgabe zurückgeben
                </button>
                <a th:href="@{/tasks}" class="btn btn-secondary ms-2 float-end">
                    <i class="bi bi-list"></i>
                    Meine Aufgaben
                </a>
                <button type="submit" name="save" class="btn btn-primary text-white float-end"
                        th:if="${userTask.status.toString() == 'TRANSMITTED'}">
                    <i class="bi bi-check"></i>
                    Speichern
                </button>
            </div>
        </div>
    </form>
</div>
</body>